import telebot
import re
import time
from threading import Timer
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

# ğŸ¯ ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª
BOT_TOKEN = "8037874043:AAHDEORIzamnxuxK1m0TWgS-C4UDlLIZ42Y"
bot = telebot.TeleBot(BOT_TOKEN, parse_mode="HTML")

# ğŸ“¡ Ø´Ù†Ø§Ø³Ù‡ Ùˆ Ù„ÛŒÙ†Ú© Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§
channel_ids = [
    '-1001293990413', '-1002303168889', '-1002016974877',
    '-1002295560799', '-1002104900802', '-1002005207697',
    '-1002120965536', '-1002135081737', '-1002176340230',
    '-1002384702556', '-1002442815941', '-1003164391143'  # Ø¬Ø¯ÛŒØ¯
]

channel_links = [
    'ğŸ’¢@Dastavalkhabar', 'ğŸ’¢@Ravayatno_ir', 'âœ…@Sobheiranian',
    'âœ…@Rrouydadnu', 'ğŸ†”@Tabriztopkhabar', 'ğŸ†”@Sobhe_mashhad',
    'ğŸ†”@Nesfeh_jahaan', 'ğŸ†”@Asre_shiraz', 'âœ…@Reisjomhor',
    'âœ…@Asriranno', 'âœ…@Akhbarjanjaly', 'ğŸ…¾ï¸@eghtesadedovom'  # Ø¬Ø¯ÛŒØ¯
]

# ğŸ‘® Ø´Ù†Ø§Ø³Ù‡ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§
ADMIN_USER_IDS = [262567832]

# ğŸ§¾ ØµÙ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
queue = []

# ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ùˆ Ø¢ÛŒâ€ŒØ¯ÛŒâ€ŒÙ‡Ø§ Ø§Ø² Ù…ØªÙ†
def remove_hyperlinks_and_links(text):
    if not text:
        return ''
    patterns = [
        r"http\S+", r"www\S+", r"@\S+", r"tn\.ai/\S*", r"ana\.ir\S*",
        r"dnws\.ir\S*", r"tv\.irna\.ir\S*", r"ğŸ”—", r"âœ…", r"ğŸ†”", r"ğŸ…¾ï¸",
        r"Link", r"\| #kamelat"
    ]
    for p in patterns:
        text = re.sub(p, '', text)
    lines = [l.strip() for l in text.split("\n") if l.strip()]
    return "\n".join(lines)

# ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ…Ø§Ù… Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§
def send_message_to_channels(text, msg_type, file_id=None):
    for ch_id, link in zip(channel_ids, channel_links):
        try:
            final_text = f"{text}\n\n{link}"
            if msg_type == 'text':
                bot.send_message(ch_id, final_text)
            elif msg_type == 'photo':
                bot.send_photo(ch_id, file_id, caption=final_text)
            elif msg_type == 'video':
                bot.send_video(ch_id, file_id, caption=final_text)
            elif msg_type == 'document':
                bot.send_document(ch_id, file_id, caption=final_text)
            elif msg_type == 'animation':
                bot.send_animation(ch_id, file_id, caption=final_text)
            elif msg_type == 'sticker':
                bot.send_sticker(ch_id, file_id)
            time.sleep(1)  # Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Flood Error
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ {link}: {e}")

# ğŸ§© Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø¢Ù†ÛŒ
def get_send_keyboard():
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("ğŸš€ Ø§Ø±Ø³Ø§Ù„ Ø¢Ù†ÛŒ", callback_data="send_now"))
    return kb

# ğŸ¤– Ù‡Ù†Ø¯Ù„ Ù‡Ù…Ù‡â€ŒÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
@bot.message_handler(content_types=['text', 'photo', 'video', 'document', 'animation', 'sticker'])
def handle_message(message):
    user_id = message.from_user.id
    chat_id = message.chat.id

    if user_id not in ADMIN_USER_IDS:
        bot.send_message(chat_id, "â›” Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù†ÛŒØ³ØªÛŒØ¯.")
        return

    # âœ… Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯ÙˆØ¨Ø§Ø±Ù‡ (Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ø¯ÙˆØ¨Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ú©Ù…Ù‡)
    if getattr(message, "processed", False):
        return
    message.processed = True

    msg_type = message.content_type
    file_id, cleaned = None, ""

    try:
        if msg_type == 'text':
            cleaned = remove_hyperlinks_and_links(message.text)
        else:
            cleaned = remove_hyperlinks_and_links(message.caption or "")
            if msg_type == 'photo':
                file_id = message.photo[-1].file_id
            elif msg_type == 'video':
                file_id = message.video.file_id
            elif msg_type == 'document':
                file_id = message.document.file_id
            elif msg_type == 'animation':
                file_id = message.animation.file_id
            elif msg_type == 'sticker':
                file_id = message.sticker.file_id
                cleaned = ""

        queue.append((cleaned, msg_type, file_id, chat_id))
        bot.send_message(chat_id, f"âœ… {msg_type} Ø¯Ø± ØµÙ Ø§Ø±Ø³Ø§Ù„ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª.", reply_markup=get_send_keyboard())
    except Exception as e:
        bot.send_message(chat_id, f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´: {e}")

# ğŸš€ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø¢Ù†ÛŒ
@bot.callback_query_handler(func=lambda c: c.data == "send_now")
def send_now_callback(call):
    if call.from_user.id not in ADMIN_USER_IDS:
        bot.answer_callback_query(call.id, "â›” Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³ØªÛŒØ¯.")
        return

    if not queue:
        bot.send_message(call.message.chat.id, "ğŸ“­ ØµÙ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.")
        return

    msg = queue.pop(-1)
    send_message_to_channels(*msg[:-1])
    bot.send_message(call.message.chat.id, "âœ… Ù¾ÛŒØ§Ù… ÙÙˆØ±Ø§Ù‹ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")

# ğŸ•’ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡
def process_queue():
    if queue:
        msg = queue.pop(0)
        send_message_to_channels(*msg[:-1])
        bot.send_message(msg[-1], "ğŸ“¨ Ù¾ÛŒØ§Ù… Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
    Timer(1800, process_queue).start()

# ğŸ”° ØªØ³Øª /start
@bot.message_handler(commands=['start'])
def start_cmd(message):
    if message.from_user.id in ADMIN_USER_IDS:
        bot.reply_to(message, "âœ… Ø±Ø¨Ø§Øª ÙØ¹Ø§Ù„ Ø§Ø³Øª Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù….")
    else:
        bot.reply_to(message, "â›” Ø´Ù…Ø§ Ø§Ø¯Ù…ÛŒÙ† Ù†ÛŒØ³ØªÛŒØ¯.")

# ğŸš¦ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª
if __name__ == "__main__":
    print("ğŸ¤– Ø±Ø¨Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§Ø³Øª...")
    Timer(1800, process_queue).start()
    bot.infinity_polling(timeout=30, long_polling_timeout=10)
